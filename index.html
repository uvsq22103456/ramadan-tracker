<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ramadan Sisters üåô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const GEMINI_API_KEY = "AIzaSyCs6Az532CxZuWzHS3MalpbiGERC0TsSQI"; 
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ramadan-sisters-final';

        // --- √âTAT GLOBAL ---
        let currentUser = null;
        let activeDayIdx = 1;
        let userData = {};
        const USERS = [
            { id: 'samia', name: 'Samia', pin: '2025', color: 'bg-rose-100 text-rose-600' },
            { id: 'enora', name: 'Enora', pin: '0000', color: 'bg-blue-100 text-blue-600' },
            { id: 'kelly', name: 'Kelly', pin: '1234', color: 'bg-emerald-100 text-emerald-600' },
            { id: 'cherryl', name: 'Cherryl', pin: '8888', color: 'bg-purple-100 text-purple-600' }
        ];

        const PRAYERS = ["Fajr", "Dohr", "Asr", "Magh", "Isha"];

        // --- INITIALISATION ---
        async function initApp() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) renderProfileList();
                });
            } catch (error) {
                console.error("Auth Error:", error);
            }
        }

        async function callGemini(prompt, system) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: system }] }
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Pas de r√©ponse.";
            } catch (e) { return "Erreur IA."; }
        }

        async function syncData(userId) {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_progress', userId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                userData = docSnap.data();
            } else {
                userData = {};
                for(let i=1; i<=30; i++) {
                    userData[i] = { fasting: false, prayers: [false,false,false,false,false], surah: "", quranNotes: "", journal: "", water: 0, protein: 0, protGoal: 60, dhikr: 0, objectives: [] };
                }
                await setDoc(docRef, userData);
            }
            refreshUI();
        }

        async function pushData() {
            if (!auth.currentUser || !currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_progress', currentUser.id);
            await setDoc(docRef, userData);
        }

        // --- ACTIONS WINDOW ---
        window.pressKey = (n) => { const d = document.getElementById('pin-display'); if (d.value.length < 4) d.value += n; };
        window.clearPin = () => document.getElementById('pin-display').value = "";
        window.validatePin = () => {
            const input = document.getElementById('pin-display').value;
            if (input === window.selectedLoginUser.pin) window.doLogin(window.selectedLoginUser);
            else { alert("Code incorrect !"); window.clearPin(); }
        };
        window.doLogin = (user) => {
            currentUser = user;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('app-nav').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = `Salam, ${user.name} ‚ú®`;
            syncData(user.id);
        };
        window.selectDay = (idx) => { activeDayIdx = idx; refreshUI(); };
        window.toggleFast = () => { userData[activeDayIdx].fasting = !userData[activeDayIdx].fasting; pushData(); refreshUI(); };
        window.togglePrayer = (i) => { userData[activeDayIdx].prayers[i] = !userData[activeDayIdx].prayers[i]; pushData(); refreshUI(); };
        window.addWater = (amt) => { userData[activeDayIdx].water = Math.max(0, userData[activeDayIdx].water + amt); pushData(); refreshUI(); };
        window.addDhikr = () => { userData[activeDayIdx].dhikr++; pushData(); document.getElementById('display-dhikr').innerText = userData[activeDayIdx].dhikr; };
        window.resetDhikr = () => { if(confirm("R√©initialiser ?")) { userData[activeDayIdx].dhikr = 0; pushData(); refreshUI(); } };
        window.saveJournal = () => {
            userData[activeDayIdx].surah = document.getElementById('input-surah').value;
            userData[activeDayIdx].quranNotes = document.getElementById('input-quran-notes').value;
            userData[activeDayIdx].journal = document.getElementById('input-journal').value;
            pushData();
            showToast("C'est sauvegard√© ! ‚ú®");
        };
        window.askAIQuran = async () => {
            const box = document.getElementById('quran-ai-response');
            const surah = document.getElementById('input-surah').value;
            if(!surah) return alert("Pr√©cise une sourate !");
            box.classList.remove('hidden'); box.innerText = "Analyse... ‚ú®";
            const res = await callGemini(`Sourate lue : "${surah}"`, "Explique le th√®me de cette sourate bri√®vement en 2 lignes max.");
            box.innerText = res;
        };

        // OBJECTIFS LOGIC
        window.addObjective = () => {
            const input = document.getElementById('objective-input');
            const val = input.value.trim();
            if(!val) return;
            if(!userData[activeDayIdx].objectives) userData[activeDayIdx].objectives = [];
            userData[activeDayIdx].objectives.push({ text: val, done: false });
            input.value = "";
            pushData();
            refreshUI();
        };

        window.toggleObjective = (i) => {
            userData[activeDayIdx].objectives[i].done = !userData[activeDayIdx].objectives[i].done;
            pushData();
            refreshUI();
        };

        window.removeObjective = (i) => {
            userData[activeDayIdx].objectives.splice(i, 1);
            pushData();
            refreshUI();
        };

        function renderProfileList() {
            document.getElementById('profile-grid').innerHTML = USERS.map(u => `
                <button onclick="window.initiateLogin('${u.id}')" class="bg-white p-6 rounded-[2.5rem] shadow-sm flex flex-col items-center gap-3 active:scale-95 transition">
                    <div class="w-16 h-16 rounded-full ${u.color} flex items-center justify-center text-xl font-bold">${u.name.charAt(0)}</div>
                    <span class="font-bold text-slate-700">${u.name}</span>
                </button>`).join('');
        }
        window.initiateLogin = (uid) => {
            window.selectedLoginUser = USERS.find(u => u.id === uid);
            document.getElementById('profile-grid').classList.add('hidden');
            document.getElementById('pin-pad').classList.remove('hidden');
            document.getElementById('pin-name').innerText = `Code de ${window.selectedLoginUser.name}`;
            window.clearPin();
        };

        function refreshUI() {
            const d = userData[activeDayIdx]; if(!d) return;
            let fasted = 0; Object.values(userData).forEach(x => { if(x.fasting) fasted++; });
            document.getElementById('stats-fast-count').innerText = fasted;

            let calHtml = "";
            for(let i=1; i<=30; i++) {
                const day = userData[i];
                const cls = `aspect-square flex items-center justify-center rounded-2xl font-bold transition ${day?.fasting ? 'bg-rose-500 text-white shadow-sm' : 'bg-white text-slate-300'} ${activeDayIdx === i ? 'ring-2 ring-rose-600 ring-offset-2' : ''}`;
                calHtml += `<button onclick="window.selectDay(${i})" class="${cls}">${i}</button>`;
            }
            document.getElementById('calendar-grid').innerHTML = calHtml;
            document.getElementById('day-title').innerText = `Jour ${activeDayIdx}`;
            
            const fBtn = document.getElementById('fast-btn');
            fBtn.innerText = d.fasting ? "OUI" : "NON";
            fBtn.className = `px-5 py-2 rounded-full text-[10px] font-black ${d.fasting ? 'bg-rose-500 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`;

            document.getElementById('prayer-grid').innerHTML = PRAYERS.map((n, i) => `
                <button onclick="window.togglePrayer(${i})" class="flex flex-col items-center gap-1">
                    <div class="w-11 h-11 rounded-2xl flex items-center justify-center ${d.prayers[i] ? 'bg-rose-500 text-white' : 'bg-slate-50 text-slate-200'}">
                        <i data-lucide="check" class="w-6 h-6"></i>
                    </div>
                    <span class="text-[8px] font-black uppercase text-slate-400">${n}</span>
                </button>`).join('');

            // Objectives Render
            const objList = document.getElementById('objectives-list');
            if(d.objectives && d.objectives.length > 0) {
                objList.innerHTML = d.objectives.map((obj, i) => `
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl mb-2">
                        <div class="flex items-center gap-3">
                            <button onclick="window.toggleObjective(${i})" class="w-5 h-5 rounded-md border-2 border-rose-200 flex items-center justify-center ${obj.done ? 'bg-rose-500 border-rose-500' : ''}">
                                ${obj.done ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                            </button>
                            <span class="text-sm ${obj.done ? 'line-through text-slate-400' : 'text-slate-700 font-medium'}">${obj.text}</span>
                        </div>
                        <button onclick="window.removeObjective(${i})" class="text-slate-300 active:text-rose-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                `).join('');
            } else {
                objList.innerHTML = '<p class="text-[10px] text-slate-400 italic py-2">Aucun objectif pour aujourd\'hui...</p>';
            }

            document.getElementById('input-surah').value = d.surah || "";
            document.getElementById('input-quran-notes').value = d.quranNotes || "";
            document.getElementById('input-journal').value = d.journal || "";
            document.getElementById('display-water').innerText = d.water.toFixed(2) + "L";
            document.getElementById('display-protein').innerText = d.protein + "g";
            document.getElementById('display-dhikr').innerText = d.dhikr;
            lucide.createIcons();
        }

        window.switchTab = (n) => {
            ['calendar', 'nutrition', 'dhikr'].forEach(t => { document.getElementById(`tab-${t}`).classList.add('hidden'); document.getElementById(`nav-${t}`).classList.replace('text-rose-600', 'text-slate-300'); });
            document.getElementById(`tab-${n}`).classList.remove('hidden');
            document.getElementById(`nav-${n}`).classList.replace('text-slate-300', 'text-rose-600');
        };
        function showToast(m) {
            const t = document.createElement('div');
            t.className = "fixed top-12 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-4 rounded-3xl text-xs font-black z-[100] animate-bounce uppercase";
            t.innerText = m; document.body.appendChild(t); setTimeout(() => t.remove(), 2000);
        }
        window.logout = () => location.reload();
        initApp();
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[#FFF9FA] text-slate-800">

    <!-- AUTH -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-12">
            <div class="bg-rose-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 border border-rose-100 shadow-sm"><i data-lucide="moon" class="text-rose-500 w-12 h-12"></i></div>
            <h1 class="text-3xl font-black text-slate-900">Ramadan Sisters</h1>
            <p class="text-slate-400 mt-2 text-sm max-w-[250px] mx-auto">Pour qu'on puisse suivre nos progr√®s et objectifs durant ce mois b√©ni ‚ú®</p>
        </div>
        <div id="profile-grid" class="grid grid-cols-2 gap-4 w-full max-w-sm"></div>
        <div id="pin-pad" class="hidden w-full max-w-xs animate-in fade-in zoom-in duration-300">
            <h2 id="pin-name" class="text-xl font-bold mb-6 text-rose-600"></h2>
            <input type="password" id="pin-display" readonly maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full text-center text-4xl tracking-[1rem] bg-rose-50 border-none rounded-2xl p-4 text-rose-600 outline-none mb-6">
            <div class="grid grid-cols-3 gap-3">
                <button onclick="window.pressKey('1')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">1</button>
                <button onclick="window.pressKey('2')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">2</button>
                <button onclick="window.pressKey('3')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">3</button>
                <button onclick="window.pressKey('4')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">4</button>
                <button onclick="window.pressKey('5')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">5</button>
                <button onclick="window.pressKey('6')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">6</button>
                <button onclick="window.pressKey('7')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">7</button>
                <button onclick="window.pressKey('8')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">8</button>
                <button onclick="window.pressKey('9')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">9</button>
                <button onclick="window.clearPin()" class="bg-rose-50 text-rose-400 p-5 rounded-2xl font-bold text-xs">ANNULER</button>
                <button onclick="window.pressKey('0')" class="bg-white p-5 rounded-2xl shadow-sm font-bold active:bg-rose-50">0</button>
                <button onclick="window.validatePin()" class="bg-rose-500 text-white p-5 rounded-2xl font-bold shadow-md active:bg-rose-600">OK</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <main id="app-content" class="hidden min-h-screen pb-32">
        <header class="p-6 pt-12 flex justify-between items-center bg-white rounded-b-[3rem] shadow-sm mb-6">
            <div><h2 id="welcome-msg" class="text-2xl font-bold italic text-slate-800">Salam !</h2><p class="text-[10px] font-bold text-rose-400 uppercase tracking-widest mt-1">Sisters Companion üåô</p></div>
            <button onclick="window.logout()" class="p-3 bg-rose-50 rounded-2xl text-rose-500"><i data-lucide="power" class="w-6 h-6"></i></button>
        </header>

        <div id="tab-calendar" class="p-4 space-y-6">
            <!-- CALENDRIER -->
            <section class="bg-white rounded-[2.5rem] p-6 shadow-sm">
                <div class="grid grid-cols-6 gap-2 mb-6" id="calendar-grid"></div>
                <div class="bg-rose-500 rounded-3xl p-5 text-white flex items-center justify-between shadow-lg shadow-rose-100">
                    <div><p class="text-[10px] font-bold uppercase opacity-80">Progression</p><p class="text-2xl font-black"><span id="stats-fast-count">0</span> / 30 <span class="text-sm font-normal italic uppercase">je√ªn√©s</span></p></div>
                    <i data-lucide="star" class="w-8 h-8 opacity-40"></i>
                </div>
            </section>

            <!-- OBJECTIFS DU JOUR -->
            <section class="bg-white rounded-[2.5rem] p-6 shadow-sm space-y-4">
                <div class="flex items-center gap-2 mb-2 text-rose-600">
                    <i data-lucide="list-checks" class="w-5 h-5"></i>
                    <h4 class="font-bold">Mes Objectifs du Jour</h4>
                </div>
                
                <div id="objectives-list" class="space-y-1">
                    <!-- Liste g√©n√©r√©e par JS -->
                </div>

                <div class="flex gap-2 pt-2">
                    <input type="text" id="objective-input" placeholder="Ajouter un objectif..." 
                           class="flex-1 bg-slate-50 border-none rounded-xl px-4 py-3 text-sm outline-none">
                    <button onclick="window.addObjective()" class="bg-rose-500 text-white p-3 rounded-xl shadow-md active:scale-95 transition">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>
            </section>

            <!-- DETAILS DU JOUR -->
            <section class="bg-white rounded-[2.5rem] p-6 shadow-sm space-y-6">
                <div class="flex justify-between items-center"><h4 id="day-title" class="text-xl font-black text-rose-600 italic">Jour 1</h4><button onclick="window.toggleFast()" id="fast-btn" class="px-5 py-2 rounded-full text-[10px] font-black">NON</button></div>
                <div class="grid grid-cols-5 gap-2" id="prayer-grid"></div>
                
                <div class="space-y-3 pt-4 border-t">
                    <div class="flex justify-between items-center"><span class="text-[10px] font-bold uppercase text-emerald-600">Coran</span><button onclick="window.askAIQuran()" class="text-[9px] bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full font-bold">EXPLICATION ‚ú®</button></div>
                    <input type="text" id="input-surah" placeholder="Sourate..." class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm outline-none">
                    <div id="quran-ai-response" class="hidden text-[11px] p-4 bg-emerald-50 text-emerald-800 rounded-2xl italic mb-2"></div>
                    <textarea id="input-quran-notes" placeholder="Notes de lecture..." class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm outline-none"></textarea>
                </div>

                <div class="space-y-3 border-t pt-4">
                    <span class="text-[10px] font-bold uppercase text-rose-400">Journal Personnel</span>
                    <textarea id="input-journal" placeholder="Comment je me sens aujourd'hui ?" class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm outline-none"></textarea>
                </div>

                <button onclick="window.saveJournal()" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black text-sm tracking-widest shadow-xl active:scale-95 transition">SAUVEGARDER MA JOURN√âE</button>
            </section>
        </div>

        <!-- ONGLET CUISINE -->
        <div id="tab-nutrition" class="hidden p-4 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-[2.5rem] text-center shadow-sm">
                    <div class="text-xs text-blue-300 font-bold mb-2 uppercase">Eau</div>
                    <div id="display-water" class="text-2xl font-black text-blue-500">0.0L</div>
                    <div class="flex justify-center gap-2 mt-4"><button onclick="window.addWater(0.25)" class="bg-blue-50 w-10 h-10 rounded-full font-bold text-blue-500 flex items-center justify-center">+</button><button onclick="window.addWater(-0.25)" class="bg-slate-50 w-10 h-10 rounded-full font-bold text-slate-300 flex items-center justify-center">-</button></div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] text-center shadow-sm">
                    <div class="text-xs text-orange-300 font-bold mb-2 uppercase tracking-tighter">Prot√©ines</div>
                    <div id="display-protein" class="text-2xl font-black text-orange-500">0g</div>
                    <button onclick="const p=prompt('Grammes de prot√©ines?'); if(p) { userData[activeDayIdx].protein+=parseInt(p); window.pushData(); window.selectDay(activeDayIdx); }" class="mt-4 bg-orange-50 px-4 py-2 rounded-full text-[10px] font-black uppercase text-orange-500">Ajouter</button>
                </div>
            </div>
            <section class="bg-white p-6 rounded-[2.5rem] shadow-sm">
                <h4 class="text-xs font-bold text-rose-500 mb-4 uppercase tracking-widest">Le Suhoor des Sisters üçïü•û</h4>
                <div class="space-y-4">
                    <div class="p-4 bg-rose-50 rounded-2xl flex items-center gap-4">
                        <span class="text-2xl">ü•û</span>
                        <div>
                            <h5 class="font-bold text-sm">Pancakes Nutella</h5>
                            <p class="text-[10px] text-slate-500 italic">Nutella, banane et miel pour le plaisir.</p>
                        </div>
                    </div>
                    <div class="p-4 bg-orange-50 rounded-2xl flex items-center gap-4">
                        <span class="text-2xl">üåÆ</span>
                        <div>
                            <h5 class="font-bold text-sm">Quesadillas Sal√©es</h5>
                            <p class="text-[10px] text-slate-500 italic">Poulet, fromage et tortilla toast√©e.</p>
                        </div>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-2xl flex items-center gap-4">
                        <span class="text-2xl">üçØ</span>
                        <div>
                            <h5 class="font-bold text-sm">Baghrir Tradition</h5>
                            <p class="text-[10px] text-slate-500 italic">M√©lange miel et beurre fondu.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- DHIKR -->
        <div id="tab-dhikr" class="hidden p-4 h-[70vh] flex flex-col items-center justify-center text-center">
            <div id="display-dhikr" class="text-[10rem] font-black text-rose-500 leading-none mb-10 tracking-tighter">0</div>
            <button onclick="window.addDhikr()" class="w-64 h-64 bg-rose-500 rounded-full shadow-2xl border-[15px] border-white active:scale-90 transition-all flex items-center justify-center text-white font-black text-3xl">CLIC</button>
            <button onclick="window.resetDhikr()" class="mt-12 text-slate-300 font-bold text-xs uppercase tracking-widest">R√©initialiser</button>
        </div>
    </main>

    <nav id="app-nav" class="hidden fixed bottom-0 left-0 right-0 glass border-t flex justify-around p-4 pb-12 z-40">
        <button onclick="window.switchTab('calendar')" id="nav-calendar" class="flex flex-col items-center gap-1 text-rose-600"><i data-lucide="calendar"></i><span class="text-[9px] font-black uppercase">Suivi</span></button>
        <button onclick="window.switchTab('nutrition')" id="nav-nutrition" class="flex flex-col items-center gap-1 text-slate-300"><i data-lucide="coffee"></i><span class="text-[9px] font-black uppercase">Cuisine</span></button>
        <button onclick="window.switchTab('dhikr')" id="nav-dhikr" class="flex flex-col items-center gap-1 text-slate-300"><i data-lucide="hash"></i><span class="text-[9px] font-black uppercase">Dhikr</span></button>
    </nav>

    <script>lucide.createIcons();</script>
</body>
</html>
